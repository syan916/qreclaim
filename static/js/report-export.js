(function(){
  const panels={verification:document.getElementById('panel-verification'),found:document.getElementById('panel-found'),unclaimed:document.getElementById('panel-unclaimed')};
  const cards=[...document.querySelectorAll('.report-card')];
  const startEl=document.getElementById('startDate');
  const endEl=document.getElementById('endDate');
  const applyBtn=document.getElementById('applyFiltersBtn');
  const exportPdfBtn=document.getElementById('exportPdfBtn');
  const exportExcelBtn=document.getElementById('exportExcelBtn');
  const refreshBtn=document.getElementById('refreshBtn');
  const cache=new Map();
  const CACHE_TTL=5*60*1000;
  const today=new Date();
  const startDefault=new Date(Date.now()-30*24*3600*1000);
  startEl.value=startDefault.toISOString().slice(0,10);
  endEl.value=today.toISOString().slice(0,10);

  function fmt(dt){try{return new Date(dt).toLocaleString();}catch(e){return String(dt);}}
  function fmtDateOnly(dt){try{return new Date(dt).toLocaleDateString();}catch(e){return String(dt);}}
  function showLoading(id,show){const el=document.getElementById(id);if(el)el.classList.toggle('show',!!show);}
  function pageSlice(arr,page,per){const s=(page-1)*per;return arr.slice(s,s+per);} 
  function paginate(containerId,page,totalPages,onChange){const el=document.getElementById(containerId);if(!el)return;el.innerHTML='';const prev=document.createElement('button');prev.className='btn btn-secondary';prev.textContent='Prev';prev.disabled=page<=1;prev.onclick=()=>onChange(page-1);const info=document.createElement('span');info.textContent=`Page ${page} / ${totalPages}`;const next=document.createElement('button');next.className='btn btn-secondary';next.textContent='Next';next.disabled=page>=totalPages;next.onclick=()=>onChange(page+1);el.appendChild(prev);el.appendChild(info);el.appendChild(next);} 
  function cacheKey(type){return `${type}:${startEl.value}:${endEl.value}`;} 
  function setCache(type,data){cache.set(cacheKey(type),{ts:Date.now(),data});}
  function getCache(type){const c=cache.get(cacheKey(type));if(!c)return null;return (Date.now()-c.ts)<CACHE_TTL?c.data:null;}
  async function fetchJSON(url){const res=await fetch(url);const j=await res.json();if(!j.success)throw new Error(j.error||'Request failed');return j;}

  cards.forEach(c=>c.addEventListener('click',()=>{cards.forEach(x=>x.classList.remove('active'));c.classList.add('active');Object.values(panels).forEach(p=>p.classList.remove('active'));panels[c.dataset.panel].classList.add('active');}));

  async function loadVerification(page=1){showLoading('loadingVerification',true);try{const cached=getCache('verification');let data;if(cached)data=cached;else{const url=`/admin/api/reports/claim-verification?start=${startEl.value}&end=${endEl.value}`;data=await fetchJSON(url);setCache('verification',data);}const per=10;const rows=data.rows||[];const totalPages=Math.max(1,Math.ceil(rows.length/per));const slice=pageSlice(rows,page,per);const tbl=document.getElementById('verificationTable');tbl.innerHTML=`<thead><tr><th>Claim ID</th><th>Item</th><th>Student</th><th>Status</th><th>Verification Method</th><th>Locker</th><th>Created</th></tr></thead>`+`<tbody>`+slice.map(r=>`<tr><td>${r.claim_id}</td><td>${r.item_name||'-'}</td><td>${r.student_name||r.student_id||'-'}</td><td>${r.status}</td><td>${r.verification_method||'-'}</td><td>${r.locker_id||'-'}</td><td>${fmt(r.created_at)}</td></tr>`).join('')+`</tbody>`;const summary=document.getElementById('verificationSummary');const s=data.summary||{};summary.textContent=`Pending: ${s.pending||0}, Approved: ${s.approved||0}, Rejected: ${s.rejected||0}, Verified: ${s.verified||0}`;paginate('verificationPagination',page,totalPages,(p)=>loadVerification(p));}catch(e){const tbl=document.getElementById('verificationTable');tbl.innerHTML=`<tbody><tr><td>Error: ${e.message}</td></tr></tbody>`;}finally{showLoading('loadingVerification',false);}}

  async function loadFound(page=1){showLoading('loadingFound',true);try{const cached=getCache('found');let data;if(cached)data=cached;else{const url=`/admin/api/reports/found-items-summary?start=${startEl.value}&end=${endEl.value}`;data=await fetchJSON(url);setCache('found',data);}const per=10;const rows=data.rows||[];const totalPages=Math.max(1,Math.ceil(rows.length/per));const slice=pageSlice(rows,page,per);const tbl=document.getElementById('foundSummaryTable');tbl.innerHTML=`<thead><tr><th>Category</th><th>Total</th><th>Claimed</th><th>Unclaimed</th><th>Valuable %</th></tr></thead>`+`<tbody>`+slice.map(r=>`<tr><td>${r.category}</td><td>${r.total}</td><td>${r.claimed}</td><td>${r.unclaimed}</td><td>${(r.valuable_pct||0).toFixed(1)}%</td></tr>`).join('')+`</tbody>`;paginate('foundPagination',page,totalPages,(p)=>loadFound(p));if(window.Chart && data.time_series){const ctx=document.getElementById('foundDistributionChart').getContext('2d');if(window._foundChart)window._foundChart.destroy();window._foundChart=new Chart(ctx,{type:'line',data:{labels:data.time_series.labels,datasets:[{label:'Found',data:data.time_series.found,borderColor:'#3b82f6',fill:false},{label:'Claimed',data:data.time_series.claimed,borderColor:'#10b981',fill:false},{label:'Unclaimed',data:data.time_series.unclaimed,borderColor:'#ef4444',fill:false}]},options:{responsive:true,maintainAspectRatio:false}});}}catch(e){const tbl=document.getElementById('foundSummaryTable');tbl.innerHTML=`<tbody><tr><td>Error: ${e.message}</td></tr></tbody>`;}finally{showLoading('loadingFound',false);}}

  async function loadUnclaimed(page=1){showLoading('loadingUnclaimed',true);try{const cached=getCache('unclaimed');let data;if(cached)data=cached;else{const url=`/admin/api/reports/unclaimed-items?start=${startEl.value}&end=${endEl.value}`;data=await fetchJSON(url);setCache('unclaimed',data);}const per=10;const rows=data.rows||[];const totalPages=Math.max(1,Math.ceil(rows.length/per));const slice=pageSlice(rows,page,per);const tbl=document.getElementById('unclaimedTable');tbl.innerHTML=`<thead><tr><th>Item</th><th>Category</th><th>Days Unclaimed</th><th>Admin Review</th><th>Locker</th><th>Notifications</th></tr></thead>`+`<tbody>`+slice.map(r=>`<tr><td>${r.item_name}</td><td>${r.category||'-'}</td><td>${r.days_unclaimed}</td><td>${r.admin_review_status||'-'}</td><td>${r.locker_id||'-'}</td><td>${(r.notifications||[]).slice(0,3).map(n=>`${fmtDateOnly(n.timestamp)}: ${n.title}`).join('<br>')||'-'}</td></tr>`).join('')+`</tbody>`;paginate('unclaimedPagination',page,totalPages,(p)=>loadUnclaimed(p));}catch(e){const tbl=document.getElementById('unclaimedTable');tbl.innerHTML=`<tbody><tr><td>Error: ${e.message}</td></tr></tbody>`;}finally{showLoading('loadingUnclaimed',false);}}

  function currentType(){const c=document.querySelector('.report-card.active');return c?c.dataset.panel:'verification';}

  exportPdfBtn.addEventListener('click',async()=>{
    const type=currentType();const { jsPDF }=window.jspdf||{};if(!jsPDF){alert('PDF library not loaded');return;}const doc=new jsPDF({unit:'pt',format:'a4'});const pageW=doc.internal.pageSize.getWidth();const pageH=doc.internal.pageSize.getHeight();const logoImg=new Image();const cfgEl=document.getElementById('reportConfig');const logoUrl=(cfgEl&&cfgEl.dataset.logoUrl)||'';logoImg.src=logoUrl;await new Promise(res=>{logoImg.onload=res;logoImg.onerror=res;});doc.setFontSize(22);doc.addImage(logoImg,'PNG',24,24,40,40);const title= type==='verification'?'Claim Verification Report': type==='found'?'Found Items Summary':'Long-Term Unclaimed Items';doc.text(title,80,44);doc.setFontSize(12);doc.text(`Generated: ${new Date().toLocaleString()}`,80,64);doc.text(`Range: ${startEl.value} to ${endEl.value}`,80,80);doc.addPage();const tocPage=doc.internal.getCurrentPageInfo().pageNumber;let sections=[];doc.addPage();const tablePage=doc.internal.getCurrentPageInfo().pageNumber;const bodyRows=[];if(type==='verification'){const data=getCache('verification')||await fetchJSON(`/admin/api/reports/claim-verification?start=${startEl.value}&end=${endEl.value}`);const rows=data.rows||[];rows.forEach(r=>bodyRows.push([r.claim_id,r.item_name||'-',r.student_name||r.student_id||'-',r.status,r.verification_method||'-',r.locker_id||'-',fmt(r.created_at)]));doc.autoTable({head:[['Claim ID','Item','Student','Status','Method','Locker','Created']],body:bodyRows,startY:48,styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[59,130,246],textColor:255},alternateRowStyles:{fillColor:[245,247,251]}});sections.push({label:'Data Table',page:tablePage});}else if(type==='found'){const data=getCache('found')||await fetchJSON(`/admin/api/reports/found-items-summary?start=${startEl.value}&end=${endEl.value}`);const rows=data.rows||[];rows.forEach(r=>bodyRows.push([r.category,r.total,r.claimed,r.unclaimed,`${(r.valuable_pct||0).toFixed(1)}%`]));doc.autoTable({head:[['Category','Total','Claimed','Unclaimed','Valuable %']],body:bodyRows,startY:48,styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[99,102,241],textColor:255},alternateRowStyles:{fillColor:[245,247,251]}});sections.push({label:'Data Table',page:tablePage});doc.addPage();const chartPage=doc.internal.getCurrentPageInfo().pageNumber;sections.push({label:'Time Distribution Chart',page:chartPage});if(window._foundChart){const img=window._foundChart.toBase64Image();doc.addImage(img,'PNG',24,48,pageW-48, pageH-120);} }
    else {const data=getCache('unclaimed')||await fetchJSON(`/admin/api/reports/unclaimed-items?start=${startEl.value}&end=${endEl.value}`);const rows=data.rows||[];rows.forEach(r=>bodyRows.push([r.item_name,r.category||'-',r.days_unclaimed,r.admin_review_status||'-',r.locker_id||'-']));doc.autoTable({head:[['Item','Category','Days Unclaimed','Admin Review','Locker']],body:bodyRows,startY:48,styles:{fontSize:9,cellPadding:3},headStyles:{fillColor:[16,185,129],textColor:255},alternateRowStyles:{fillColor:[245,247,251]}});sections.push({label:'Data Table',page:tablePage});}
    doc.setPage(tocPage);doc.setFontSize(16);doc.text('Table of Contents',24,40);doc.setFontSize(12);let y=64;sections.forEach(s=>{doc.text(`${s.label} ...... ${s.page}`,24,y);y+=18;});const pageCount=doc.internal.getNumberOfPages();for(let i=1;i<=pageCount;i++){doc.setPage(i);doc.setFontSize(9);const footerY=pageH-28;doc.text(`Page ${i} of ${pageCount}`,pageW-80,footerY);doc.text('Confidential â€” For internal use only',24,footerY);}doc.save(`${title.replace(/\s+/g,'_').toLowerCase()}_${startEl.value}_${endEl.value}.pdf`);
  });

  exportExcelBtn.addEventListener('click',async()=>{
    const type=currentType();let filename='report.csv';let rows=[];if(type==='verification'){const data=getCache('verification')||await fetchJSON(`/admin/api/reports/claim-verification?start=${startEl.value}&end=${endEl.value}`);data.rows.forEach(r=>rows.push([r.claim_id,r.item_name||'',r.student_name||r.student_id||'',r.status,r.verification_method||'',r.locker_id||'',fmt(r.created_at)]));filename='claim_verification.csv';}
    else if(type==='found'){const data=getCache('found')||await fetchJSON(`/admin/api/reports/found-items-summary?start=${startEl.value}&end=${endEl.value}`);data.rows.forEach(r=>rows.push([r.category,r.total,r.claimed,r.unclaimed,(r.valuable_pct||0).toFixed(2)]));filename='found_items_summary.csv';}
    else{const data=getCache('unclaimed')||await fetchJSON(`/admin/api/reports/unclaimed-items?start=${startEl.value}&end=${endEl.value}`);data.rows.forEach(r=>rows.push([r.item_name,r.category||'',r.days_unclaimed,r.admin_review_status||'',r.locker_id||'']));filename='unclaimed_items.csv';}
    const header= type==='verification'?['Claim ID','Item','Student','Status','Method','Locker','Created']: type==='found'?['Category','Total','Claimed','Unclaimed','Valuable %']: ['Item','Category','Days Unclaimed','Admin Review','Locker'];
    const csv=[header].concat(rows).map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
  });

  applyBtn.addEventListener('click',()=>{cache.clear();loadVerification();loadFound();loadUnclaimed();});
  refreshBtn.addEventListener('click',()=>{cache.clear();loadVerification();loadFound();loadUnclaimed();});
  loadVerification();loadFound();loadUnclaimed();
})();