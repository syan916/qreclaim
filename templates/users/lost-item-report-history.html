<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Lost Item Reports • QReclaim</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.png') }}">

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Shared styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user-header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/user-footer.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/browse-found-items.css') }}">

    <!-- Page-specific styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lost-item-history.css') }}">

    <!-- AOS Animation Library -->
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">

    <script>
        let state = { page:1, per_page:9, search:"", category:"", status:"", location:"", sort_by:"created_at", sort_dir:"desc" };
        async function fetchItems(){
            const params = new URLSearchParams(state);
            const res = await fetch(`/user/api/my-lost-items?${params.toString()}`);
            const data = await res.json();
            const list = document.getElementById('list');
            list.setAttribute('aria-busy', 'true');
            const filters = document.getElementById('filters');
            if(!res.ok){ list.innerHTML = `<div class='empty'>${data.error||'Failed to load'}</div>`; return; }
            const items = data.lost_items||[];
            const cats = data.filters?.categories||[];
            const locs = data.filters?.locations||[];
            const stats = data.filters?.statuses||[];
            if(!filters.dataset.ready){
                populateSelect('category', cats);
                populateSelect('location', locs);
                populateSelect('status', stats);
                filters.dataset.ready = 'true';
            }
            list.innerHTML = items.length===0 ? `<div class='empty' role='status'>No reports found.</div>` : items.map(renderItem).join('');
            renderPagination(data.pagination||{current_page:1,total_pages:1});
            list.setAttribute('aria-busy', 'false');
        }
        function renderItem(it){
            const tags = Array.isArray(it.tags)?it.tags:[];
            const img = (it.image_url||'').startsWith('data:image') ? it.image_url : "{{ url_for('static', filename='images/placeholder-item.png') }}";
            const dateStr = formatDate(it.date_lost) || '—';
            const href = `/user/lost-report-details/${encodeURIComponent(it.id || it.lost_report_id || '')}`;
            return `<a class='history-card' data-aos='fade-up' href='${href}' style='text-decoration:none'>
                <div class='thumb'>${img?`<img src='${img}' alt='${escapeHtml(it.item_name||'Item')}'/>`:''}</div>
                <div class='content'>
                    <div class='title'>${escapeHtml(it.item_name||'Unknown Item')}</div>
                    <div class='meta'>
                        <span>${escapeHtml(it.category||'—')}</span>
                        <span>•</span>
                        <span>${escapeHtml(it.place_lost||'—')}</span>
                        <span>•</span>
                        <span>${dateStr}</span>
                        <span class='status ${it.status||'Open'}'>${it.status||'Open'}</span>
                    </div>
                    <div class='chips'>${tags.map(t=>`<span class='chip'>${escapeHtml(t)}</span>`).join('')}</div>
                </div>
            </a>`;
        }
        function renderPagination(p){
            const el = document.getElementById('pagination');
            el.innerHTML = `<button class='btn btn-secondary' ${p.has_prev?"":"disabled"} onclick='prevPage()'>Prev</button>
                            <span class='page-indicator'>Page ${p.current_page||1} of ${p.total_pages||1}</span>
                            <button class='btn btn-secondary' ${p.has_next?"":"disabled"} onclick='nextPage()'>Next</button>`;
        }
        function prevPage(){ if(state.page>1){ state.page--; fetchItems(); } }
        function nextPage(){ state.page++; fetchItems(); }
        function populateSelect(id, options){ const sel = document.getElementById(id); sel.innerHTML = `<option value=''>All</option>` + options.map(o=>`<option>${escapeHtml(o)}</option>`).join(''); }
        function onSearch(ev){ state.search = ev.target.value.trim(); state.page=1; debounceFetch(); }
        function onChange(id){ return ev=>{ state[id] = ev.target.value; state.page=1; fetchItems(); } }
        function onSort(){ const el=document.getElementById('sort'); const dir=document.getElementById('sort_dir'); state.sort_by=el.value; state.sort_dir=dir.value; state.page=1; fetchItems(); }
        function debounce(fn, ms){ let t; return function(){ clearTimeout(t); t=setTimeout(fn, ms); } }
        const debounceFetch = debounce(fetchItems, 250);
        function formatDate(ts){ try { if(!ts) return ''; if(ts._seconds){ return new Date(ts._seconds*1000).toLocaleDateString(); } return new Date(ts).toLocaleDateString(); } catch(_){ return ''; } }
        function escapeHtml(str){ return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s])); }
        window.addEventListener('DOMContentLoaded', fetchItems);
    </script>
</head>
<body>
    {% include 'partials/user-header.html' %}

    <main class="main-content">
        <!-- Page Header -->
        <section class="page-header py-4" data-aos="fade-down">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="page-title mb-2"><i class="fas fa-clipboard-list me-2"></i> My Lost Item Reports</h1>
                        <p class="page-subtitle mb-0">Search, filter, and review all your submissions</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <nav aria-label="breadcrumb">
                            <ol class="breadcrumb mb-0">
                                <li class="breadcrumb-item"><a href="{{ url_for('user.dashboard') }}"><i class="fas fa-home"></i> Dashboard</a></li>
                                <li class="breadcrumb-item active" aria-current="page">History</li>
                            </ol>
                        </nav>
                    </div>
                </div>
            </div>
        </section>

        <!-- Filters & Actions -->
        <section class="py-3" data-aos="fade-up" data-aos-delay="100">
            <div class="container">
                <div class="history-filters card-like" id="filters" data-ready="">
                    <div class="row g-2 align-items-center">
                        <div class="col-12 col-md-6 col-lg-4">
                            <input type="text" class="form-control" placeholder="Search by name, description, tag" oninput="onSearch(event)">
                        </div>
                        <div class="col-6 col-md-2 col-lg-2">
                            <select id="category" class="form-select" onchange="onChange('category')(event)"><option value="">All</option></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-2">
                            <select id="location" class="form-select" onchange="onChange('location')(event)"><option value="">All</option></select>
                        </div>
                        <div class="col-6 col-md-2 col-lg-2">
                            <select id="status" class="form-select" onchange="onChange('status')(event)"><option value="">All</option></select>
                        </div>
                    </div>
                    <div class="row mt-2 justify-content-end g-2">
                        <div class="col-auto">
                            <select id="sort" class="form-select" onchange="onSort()">
                                <option value="created_at">Newest</option>
                                <option value="date_lost">Date Lost</option>
                                <option value="item_name">Item Name</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <select id="sort_dir" class="form-select" onchange="onSort()">
                                <option value="desc">Desc</option>
                                <option value="asc">Asc</option>
                            </select>
                        </div>
                        <div class="col-auto">
                            <a class="btn btn-secondary" href="{{ url_for('user.report_lost_item') }}"><i class="fas fa-plus"></i> Report New</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Results -->
        <section class="py-3" data-aos="fade-up" data-aos-delay="200">
            <div class="container">
                <div class="history-grid" id="list" role="list" aria-live="polite" aria-busy="false"></div>
                <div class="history-pagination" id="pagination"></div>
            </div>
        </section>
    </main>

    {% include 'partials/user-footer.html' %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/user-header.js') }}"></script>
    <script src="{{ url_for('static', filename='js/dashboard-animations.js') }}"></script>
    <script src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script>
        AOS.init({ duration: 800, easing: 'ease-in-out', once: true, offset: 100 });
    </script>
</body>
</html>